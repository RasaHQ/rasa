x-license: &license
  RASA_PRO_LICENSE: ${RASA_PRO_LICENSE}


configs:
  endpoints.yml:
    content: |
      action_endpoint:
        url: "grpc://rasa-grpc-action-server:${RASA_SDK_PORT}"
  endpoints-ssl.yml:
    content: |
      action_endpoint:
        url: "grpc://rasa-grpc-ssl-action-server:${RASA_SDK_SSL_PORT}"
        cafile: "/app/certs/ca.pem"
  action-server-endpoints.yml:
    content: |
        empty: "empty"

services:
  rasa-pro:
    image: ${RASA_REPOSITORY}:${RASA_IMAGE_TAG}
    volumes:
      - "./simple_nlu_bot:/app"
    configs:
      - source: endpoints.yml
        target: /app/endpoints.yml
    entrypoint: ""
    command: rasa run -p ${RASA_PORT} --enable-api
    networks: [ 'rasa-pro-network' ]
    ports:
      - "${RASA_GRPC_PORT}:${RASA_PORT}"
    environment:
      <<: *license
    healthcheck:
      test: curl localhost:${RASA_PORT} || exit 1
      interval: 10s
      retries: 10
      start_period: 15s
      timeout: 10s
    user: ${USER_ID}
    depends_on:
      - rasa-grpc-action-server

  rasa-pro-grpc-ssl:
    image: ${RASA_REPOSITORY}:${RASA_IMAGE_TAG}
    volumes:
      - "./simple_nlu_bot:/app"
      - "./certs/ca.pem:/app/certs/ca.pem"
    configs:
      - source: endpoints-ssl.yml
        target: /app/endpoints-ssl.yml
    entrypoint: ""
    command: rasa run -p ${RASA_PORT} --enable-api --endpoints /app/endpoints-ssl.yml
    networks: [ 'rasa-pro-network' ]
    ports:
      - "${RASA_GRPC_SSL_PORT}:${RASA_PORT}"
    environment:
      <<: *license
    healthcheck:
      test: curl localhost:${RASA_PORT} || exit 1
      interval: 10s
      retries: 10
      start_period: 15s
      timeout: 10s
    user: ${USER_ID}
    depends_on:
      - rasa-grpc-ssl-action-server


  rasa-grpc-action-server:
    image: ${RASA_REPOSITORY}:${RASA_IMAGE_TAG}
    volumes:
      - "./simple_nlu_bot/actions:/app/actions"
    configs:
      - source: action-server-endpoints.yml
        target: /app/endpoints.yml
    networks: [ 'rasa-pro-network' ]
    entrypoint: ""
    command: rasa run actions -p ${RASA_SDK_PORT} --grpc
    ports:
      - "${RASA_SDK_PORT}:${RASA_SDK_PORT}"
    environment:
      <<: *license


  rasa-grpc-ssl-action-server:
    image: ${RASA_REPOSITORY}:${RASA_IMAGE_TAG}
    volumes:
      - "./certs/server.pem:/app/certs/server.pem"
      - "./certs/server-key.pem:/app/certs/server-key.pem"
      - "./simple_nlu_bot/actions:/app/actions"
    configs:
      - source: action-server-endpoints.yml
        target: /app/endpoints.yml
    networks: [ 'rasa-pro-network' ]
    entrypoint: ""
    command: rasa run actions -p ${RASA_SDK_SSL_PORT} --grpc --ssl-certificate /app/certs/server.pem --ssl-keyfile /app/certs/server-key.pem
    ports:
      - "${RASA_SDK_SSL_PORT}:${RASA_SDK_SSL_PORT}"
    environment:
      <<: *license


networks: { rasa-pro-network: { } }
