
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forms</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/banner.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Retrieval Actions" href="../retrieval-actions/" />
    <link rel="prev" title="Slots" href="../slots/" />

  <!-- Google Tag Manager -->
  <script type="opt-in" data-type="application/javascript" data-name="analytics">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MMHSZCS');</script>
  <!-- End Google Tag Manager -->
   
  
  <meta itemprop="image" content="https://rasa.com/assets/img/facebook-og.png">
  <meta property="og:title" content="Forms" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://rasa.com/assets/img/facebook-og.png" />
  <meta property="og:url" content="https://rasa.com/docs/rasa/core/forms" />
  
    <meta name="description" content="Follow a rule-based process of information gathering using FormActions
in open source bot framework Rasa." />
    <meta itemprop="description" content="Follow a rule-based process of information gathering using FormActions
in open source bot framework Rasa.">
    <meta name="twitter:description" content="Follow a rule-based process of information gathering using FormActions
in open source bot framework Rasa." />
    <meta property="og:description" content="Follow a rule-based process of information gathering using FormActions
in open source bot framework Rasa." />
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Rasa_HQ">
  <meta name="twitter:title" content="Forms">
  <meta name="twitter:creator" content="@Rasa_HQ">
  <meta name="twitter:image" content="https://rasa.com/assets/img/facebook-og.png">

  <link rel="stylesheet" href="../../_static/xq-light.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/fontawesome/css/fontawesome-all.css" type="text/css" />
  <link rel="stylesheet" type="text/css" href="https://rasa.com/assets/css/klaro.css">
  <script defer type="text/javascript" src="https://rasa.com/assets/js/klaro_config.js"></script>
  <script defer type="text/javascript" src="https://rasa.com/assets/js/klaro.js"></script>
  <script defer type="text/javascript" src="../../_static/ace/src-min-noconflict/ace.js"></script>
  <script defer type="text/javascript" src="../../_static/chatblock/rasa-chatblock.min.js"></script>
  <script type="text/javascript" src="https://storage.googleapis.com/docs-theme/clipboard.min.js"></script>
  
    <link rel="icon" sizes="192x192" href="../../_static/icon-192x192.png">
    <link rel="apple-touch-icon" href="../../_static/icon-192x192.png" />
  
  


  </head><body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe data-name="analytics" data-src="https://www.googletagmanager.com/ns.html?id=GTM-MMHSZCS" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<div class="announce-bar" role="banner">
  These docs are for version 1.x of Rasa Open Source.
  <a href="https://rasa.com/docs/rasa/">Docs for the new version 2.0 can be found here.</a>
</div>

<div class="nav-top">
  <div class="nav-container">
    <ul class="main-nav nav">
      <li>
      <a href="https://rasa.com/docs/" class="brand-link">
          <img src="../../_static/rasa_logo.svg" width="80px" height="40px" title="Rasa logo" alt="Rasa logo">
    	    <span class="logo extension">docs</span>
    	</a>
      </li>
    </ul>
    <ul class="secondary-nav nav">
      <li>
        <a href="https://github.com/rasaHQ/" target="_blank"><button class="button btn-ghost white"> <i class="fab fa-github"></i>GitHub</button></a>
      </li>
      <li>
        <a href="https://forum.rasa.com" target="_blank"><button class="button"><i class="fas fa-comments"></i> Ask the Community</button></a>
      </li>
    </ul>
  </div>
</div>

  
    
      <div class="sidebar-extended"></div>
    
  

  
    
      <div class="document">
    
  

    
      
        
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/rasa-tutorial/">Tutorial: Rasa Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/building-assistants/">Tutorial: Building Assistants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/command-line-interface/">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/messaging-and-voice-channels/">Messaging and Voice Channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/evaluating-models/">Evaluating Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/validate-files/">Validate Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/running-the-server/">Running the Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/how-to-deploy/">Deploying your Rasa Assistant</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide/cloud-storage/">Cloud Storage</a></li>
</ul>
<p class="caption"><span class="caption-text">NLU</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/about/">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/using-nlu-only/">Using NLU Only</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/training-data-format/">Training Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/choosing-a-pipeline/">Choosing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/language-support/">Language Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/entity-extraction/">Entity Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nlu/components/">Components</a></li>
</ul>
<p class="caption"><span class="caption-text">Core</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stories/">Stories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../domains/">Domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../responses/">Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../actions/">Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policies/">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../slots/">Slots</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../retrieval-actions/">Retrieval Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interactive-learning/">Interactive Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fallback-actions/">Fallback Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../knowledge-bases/">Knowledge Base Actions</a></li>
</ul>
<p class="caption"><span class="caption-text">Conversation Design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dialogue-elements/dialogue-elements/">Dialogue Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dialogue-elements/small-talk/">Small Talk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dialogue-elements/completing-tasks/">Completing Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dialogue-elements/guiding-users/">Guiding Users</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/action-server/">Action Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/http-api/">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/jupyter-notebooks/">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/agent/">Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/custom-nlu-components/">Custom NLU Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/rasa-sdk/">Rasa SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/events/">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/tracker/">Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/tracker-stores/">Tracker Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/event-brokers/">Event Brokers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/lock-stores/">Lock Stores</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/training-data-importers/">Training Data Importers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/core-featurization/">Featurization of Conversations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migration-guide/">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog/">Rasa OSS Change Log</a></li>
</ul>
<p class="caption"><span class="caption-text">Migrate from (beta)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../migrate-from/google-dialogflow-to-rasa/">Dialogflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrate-from/facebook-wit-ai-to-rasa/">Wit.ai</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrate-from/microsoft-luis-to-rasa/">LUIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrate-from/ibm-watson-to-rasa/">IBM Watson</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>

<div class="versions">
    <p class="caption">Versions</p>
    <div class="versions-content">
      <div>
        <span class="current-version">
          viewing: 1.7.1
        </span>
      </div>
      <div class="other-versions">
          <p>tags</p>
          <div class="dropdown-content">
              <a href="../../../1.10.17/core/forms/">1.10.17</a>
              <a href="../../../1.10.16/core/forms/">1.10.16</a>
              <a href="../../../1.10.15/core/forms/">1.10.15</a>
              <a href="../../../1.10.14/core/forms/">1.10.14</a>
              <a href="../../../1.10.13/core/forms/">1.10.13</a>
              <a href="../../../1.10.12/core/forms/">1.10.12</a>
              <a href="../../../1.10.11/core/forms/">1.10.11</a>
              <a href="../../../1.10.10/core/forms/">1.10.10</a>
              <a href="../../../1.10.9/core/forms/">1.10.9</a>
              <a href="../../../1.10.8/core/forms/">1.10.8</a>
              <a href="../../../1.10.7/core/forms/">1.10.7</a>
              <a href="../../../1.10.6/core/forms/">1.10.6</a>
              <a href="../../../1.10.5/core/forms/">1.10.5</a>
              <a href="../../../1.10.4/core/forms/">1.10.4</a>
              <a href="../../../1.10.3/core/forms/">1.10.3</a>
              <a href="../../../1.10.2/core/forms/">1.10.2</a>
              <a href="../../../1.10.1/core/forms/">1.10.1</a>
              <a href="../../../1.10.0/core/forms/">1.10.0</a>
              <a href="../../../1.9.7/core/forms/">1.9.7</a>
              <a href="../../../1.9.6/core/forms/">1.9.6</a>
              <a href="../../../1.9.5/core/forms/">1.9.5</a>
              <a href="../../../1.9.4/core/forms/">1.9.4</a>
              <a href="../../../1.9.3/core/forms/">1.9.3</a>
              <a href="../../../1.9.2/core/forms/">1.9.2</a>
              <a href="../../../1.9.1/core/forms/">1.9.1</a>
              <a href="../../../1.9.0/core/forms/">1.9.0</a>
              <a href="../../../1.8.3/core/forms/">1.8.3</a>
              <a href="../../../1.8.2/core/forms/">1.8.2</a>
              <a href="../../../1.8.1/core/forms/">1.8.1</a>
              <a href="../../../1.8.0/core/forms/">1.8.0</a>
              <a href="../../../1.7.4/core/forms/">1.7.4</a>
              <a href="../../../1.7.3/core/forms/">1.7.3</a>
              <a href="../../../1.7.2/core/forms/">1.7.2</a>
              <a href="../../../1.7.1/core/forms/">1.7.1</a>
              <a href="../../../1.7.0/core/forms/">1.7.0</a>
              <a href="../../../1.6.2/core/forms/">1.6.2</a>
              <a href="../../../1.5.3/core/forms/">1.5.3</a>
              <a href="../../../1.4.6/core/forms/">1.4.6</a>
              <a href="../../../1.3.10/core/forms/">1.3.10</a>
              <a href="../../../1.2.9/core/forms/">1.2.9</a>
          </div>
      </div>
    </div>
</div>


        </div>
      </div>
      
    
      
        
      
        <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  


    
    



    <p class="scv-banner"><a href="../../../1.10.17/core/forms/"><b>Warning:</b> This document is for an old version of Rasa. The latest version is 1.10.17.</a></p>
<div class="section" id="forms">
<span id="id1"></span><h1>Forms<a class="headerlink" href="#forms" title="Permalink to this headline">¶</a></h1>

  <div class="edit-link">
    <a class="reference external" href="https://github.com/RasaHQ/rasa/edit/master/docs/core/forms.rst" target="_blank"><i class="fab fa-github" style="font-size: 85%; padding-right: 4px;"></i>SUGGEST EDITS</a>
  </div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is an in-depth tutorial <a class="reference external" href="https://blog.rasa.com/building-contextual-assistants-with-rasa-formaction/">here</a> about how to use Rasa Forms for slot filling.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#configuration-file" id="id2">Configuration File</a></p></li>
<li><p><a class="reference internal" href="#form-basics" id="id3">Form Basics</a></p></li>
<li><p><a class="reference internal" href="#custom-slot-mappings" id="id4">Custom slot mappings</a></p></li>
<li><p><a class="reference internal" href="#validating-user-input" id="id5">Validating user input</a></p></li>
<li><p><a class="reference internal" href="#handling-unhappy-paths" id="id6">Handling unhappy paths</a></p></li>
<li><p><a class="reference internal" href="#the-requested-slot-slot" id="id7">The requested_slot slot</a></p></li>
<li><p><a class="reference internal" href="#handling-conditional-slot-logic" id="id8">Handling conditional slot logic</a></p></li>
<li><p><a class="reference internal" href="#debugging" id="id9">Debugging</a></p></li>
</ul>
</div>
<p>One of the most common conversation patterns is to collect a few pieces of
information from a user in order to do something (book a restaurant, call an
API, search a database, etc.). This is also called <strong>slot filling</strong>.</p>
<p>If you need to collect multiple pieces of information in a row, we recommended
that you create a <code class="docutils literal notranslate"><span class="pre">FormAction</span></code>. This is a single action which contains the
logic to loop over the required slots and ask the user for this information.
There is a full example using forms in the <code class="docutils literal notranslate"><span class="pre">examples/formbot</span></code> directory of
Rasa Core.</p>
<p>When you define a form, you need to add it to your domain file.
If your form’s name is <code class="docutils literal notranslate"><span class="pre">restaurant_form</span></code>, your domain would look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">forms</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">restaurant_form</span>
<span class="nt">actions</span><span class="p">:</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">examples/formbot/domain.yml</span></code> for an example.</p>
<div class="section" id="configuration-file">
<h2><a class="toc-backref" href="#id2">Configuration File</a><a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h2>
<p>To use forms, you also need to include the <code class="docutils literal notranslate"><span class="pre">FormPolicy</span></code> in your policy
configuration file. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;FormPolicy&quot;</span>
</pre></div>
</div>
<p>see <code class="docutils literal notranslate"><span class="pre">examples/formbot/config.yml</span></code> for an example.</p>
</div>
<div class="section" id="form-basics">
<h2><a class="toc-backref" href="#id3">Form Basics</a><a class="headerlink" href="#form-basics" title="Permalink to this headline">¶</a></h2>
<p>Using a <code class="docutils literal notranslate"><span class="pre">FormAction</span></code>, you can describe <em>all</em> of the happy paths with a single
story. By “happy path”, we mean that whenever you ask a user for some information,
they respond with the information you asked for.</p>
<p>If we take the example of the restaurant bot, this single story describes all of the
happy paths.</p>
<div class="highlight-story notranslate"><div class="highlight"><pre><span></span><span class="gh">## happy path</span>
<span class="vm">* request_restaurant</span>
<span class="vm">    </span>- restaurant_form
    - form{&quot;name&quot;: &quot;restaurant_form&quot;}
    - form{&quot;name&quot;: null}
</pre></div>
</div>
<p>In this story the user intent is <code class="docutils literal notranslate"><span class="pre">request_restaurant</span></code>, which is followed by
the form action <code class="docutils literal notranslate"><span class="pre">restaurant_form</span></code>. With <code class="docutils literal notranslate"><span class="pre">form{&quot;name&quot;:</span> <span class="pre">&quot;restaurant_form&quot;}</span></code> the
form is activated and with <code class="docutils literal notranslate"><span class="pre">form{&quot;name&quot;:</span> <span class="pre">null}</span></code> the form is deactivated again.
As shown in the section <a class="reference internal" href="#section-unhappy"><span class="std std-ref">Handling unhappy paths</span></a> the bot can execute any kind of
actions outside the form while the form is still active. On the “happy path”,
where the user is cooperating well and the system understands the user input correctly,
the form is filling all requested slots without interruption.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">FormAction</span></code> will only request slots which haven’t already been set.
If a user starts the conversation with
<cite>I’d like a vegetarian Chinese restaurant for 8 people</cite>, then they won’t be
asked about the <code class="docutils literal notranslate"><span class="pre">cuisine</span></code> and <code class="docutils literal notranslate"><span class="pre">num_people</span></code> slots.</p>
<p>Note that for this story to work, your slots should be <a class="reference internal" href="../slots/#unfeaturized-slot"><span class="std std-ref">unfeaturized</span></a>. If any of these slots are featurized, your story needs to
include <code class="docutils literal notranslate"><span class="pre">slot{}</span></code> events to show these slots being set. In that case, the
easiest way to create valid stories is to use <a class="reference internal" href="../interactive-learning/#interactive-learning"><span class="std std-ref">Interactive Learning</span></a>.</p>
<p>In the story above, <code class="docutils literal notranslate"><span class="pre">restaurant_form</span></code> is the name of our form action.
Here is an example of what it looks like.
You need to define three methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: the name of this action</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">required_slots</span></code>: a list of slots that need to be filled for the <code class="docutils literal notranslate"><span class="pre">submit</span></code> method to work.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">submit</span></code>: what to do at the end of the form, when all the slots have been filled.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Text</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Unique identifier of the form&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;restaurant_form&quot;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">required_slots</span><span class="p">(</span><span class="n">tracker</span><span class="p">:</span> <span class="n">Tracker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;A list of required slots that the form has to fill&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;cuisine&quot;</span><span class="p">,</span> <span class="s2">&quot;num_people&quot;</span><span class="p">,</span> <span class="s2">&quot;outdoor_seating&quot;</span><span class="p">,</span> <span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">submit</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dispatcher</span><span class="p">:</span> <span class="n">CollectingDispatcher</span><span class="p">,</span>
    <span class="n">tracker</span><span class="p">:</span> <span class="n">Tracker</span><span class="p">,</span>
    <span class="n">domain</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Define what the form has to do</span>
<span class="sd">        after all required slots are filled&quot;&quot;&quot;</span>

    <span class="c1"># utter submit template</span>
    <span class="n">dispatcher</span><span class="o">.</span><span class="n">utter_message</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;utter_submit&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Once the form action gets called for the first time,
the form gets activated and the <code class="docutils literal notranslate"><span class="pre">FormPolicy</span></code> jumps in.
The <code class="docutils literal notranslate"><span class="pre">FormPolicy</span></code> is extremely simple and just always predicts the form action.
See <a class="reference internal" href="#section-unhappy"><span class="std std-ref">Handling unhappy paths</span></a> for how to work with unexpected user input.</p>
<p>Every time the form action gets called, it will ask the user for the next slot in
<code class="docutils literal notranslate"><span class="pre">required_slots</span></code> which is not already set.
It does this by looking for a response called <code class="docutils literal notranslate"><span class="pre">utter_ask_{slot_name}</span></code>,
so you need to define these in your domain file for each required slot.</p>
<p>Once all the slots are filled, the <code class="docutils literal notranslate"><span class="pre">submit()</span></code> method is called, where you can
use the information you’ve collected to do something for the user, for example
querying a restaurant API.
If you don’t want your form to do anything at the end, just use <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">[]</span></code>
as your submit method.
After the submit method is called, the form is deactivated,
and other policies in your Core model will be used to predict the next action.</p>
</div>
<div class="section" id="custom-slot-mappings">
<h2><a class="toc-backref" href="#id4">Custom slot mappings</a><a class="headerlink" href="#custom-slot-mappings" title="Permalink to this headline">¶</a></h2>
<p>If you do not define slot mappings, slots will be only filled by entities
with the same name as the slot that are picked up from the user input.
Some slots, like <code class="docutils literal notranslate"><span class="pre">cuisine</span></code>, can be picked up using a single entity, but a
<code class="docutils literal notranslate"><span class="pre">FormAction</span></code> can also support yes/no questions and free-text input.
The <code class="docutils literal notranslate"><span class="pre">slot_mappings</span></code> method defines how to extract slot values from user responses.</p>
<p>Here’s an example for the restaurant bot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">slot_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]:</span>
    <span class="sd">&quot;&quot;&quot;A dictionary to map required slots to</span>
<span class="sd">        - an extracted entity</span>
<span class="sd">        - intent: value pairs</span>
<span class="sd">        - a whole message</span>
<span class="sd">        or a list of them, where a first match will be picked&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;cuisine&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;cuisine&quot;</span><span class="p">,</span> <span class="n">not_intent</span><span class="o">=</span><span class="s2">&quot;chitchat&quot;</span><span class="p">),</span>
        <span class="s2">&quot;num_people&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span>
                <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;num_people&quot;</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;inform&quot;</span><span class="p">,</span> <span class="s2">&quot;request_restaurant&quot;</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="s2">&quot;outdoor_seating&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;seating&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_intent</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s2">&quot;affirm&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_intent</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s2">&quot;deny&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_intent</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s2">&quot;deny&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;no additional preferences&quot;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">not_intent</span><span class="o">=</span><span class="s2">&quot;affirm&quot;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="s2">&quot;feedback&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s2">&quot;feedback&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_text</span><span class="p">()],</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>The predefined functions work as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.from_entity(entity=entity_name,</span> <span class="pre">intent=intent_name)</span></code>
will look for an entity called <code class="docutils literal notranslate"><span class="pre">entity_name</span></code> to fill a slot
<code class="docutils literal notranslate"><span class="pre">slot_name</span></code> regardless of user intent if <code class="docutils literal notranslate"><span class="pre">intent_name</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>
else only if the users intent is <code class="docutils literal notranslate"><span class="pre">intent_name</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.from_intent(intent=intent_name,</span> <span class="pre">value=value)</span></code>
will fill slot <code class="docutils literal notranslate"><span class="pre">slot_name</span></code> with <code class="docutils literal notranslate"><span class="pre">value</span></code> if user intent is <code class="docutils literal notranslate"><span class="pre">intent_name</span></code>.
To make a boolean slot, take a look at the definition of <code class="docutils literal notranslate"><span class="pre">outdoor_seating</span></code>
above. Note: Slot will not be filled with user intent of message triggering
the form action. Use <code class="docutils literal notranslate"><span class="pre">self.from_trigger_intent</span></code> below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.from_trigger_intent(intent=intent_name,</span> <span class="pre">value=value)</span></code>
will fill slot <code class="docutils literal notranslate"><span class="pre">slot_name</span></code> with <code class="docutils literal notranslate"><span class="pre">value</span></code> if form was triggered with user
intent <code class="docutils literal notranslate"><span class="pre">intent_name</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.from_text(intent=intent_name)</span></code> will use the next
user utterance to fill the text slot <code class="docutils literal notranslate"><span class="pre">slot_name</span></code> regardless of user intent
if <code class="docutils literal notranslate"><span class="pre">intent_name</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code> else only if user intent is <code class="docutils literal notranslate"><span class="pre">intent_name</span></code>.</p></li>
<li><p>If you want to allow a combination of these, provide them as a list as in the
example above</p></li>
</ul>
</div>
<div class="section" id="validating-user-input">
<h2><a class="toc-backref" href="#id5">Validating user input</a><a class="headerlink" href="#validating-user-input" title="Permalink to this headline">¶</a></h2>
<p>After extracting a slot value from user input, the form will try to validate the
value of the slot. Note that by default, validation only happens if the form
action is executed immediately after user input. This can be changed in the
<code class="docutils literal notranslate"><span class="pre">_validate_if_required()</span></code> function of the <code class="docutils literal notranslate"><span class="pre">FormAction</span></code> class in Rasa SDK.
Any required slots that were filled before the initial activation of a form
are validated upon activation as well.</p>
<p>By default, validation only checks if the requested slot was successfully
extracted from the slot mappings. If you want to add custom validation, for
example to check a value against a database, you can do this by writing a helper
validation function with the name <code class="docutils literal notranslate"><span class="pre">validate_{slot-name}</span></code>.</p>
<p>Here is an example , <code class="docutils literal notranslate"><span class="pre">validate_cuisine()</span></code>, which checks if the extracted cuisine slot
belongs to a list of supported cuisines.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">cuisine_db</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Database of supported cuisines&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="s2">&quot;caribbean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chinese&quot;</span><span class="p">,</span>
            <span class="s2">&quot;french&quot;</span><span class="p">,</span>
            <span class="s2">&quot;greek&quot;</span><span class="p">,</span>
            <span class="s2">&quot;indian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;italian&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mexican&quot;</span><span class="p">,</span>
        <span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">validate_cuisine</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Text</span><span class="p">,</span>
        <span class="n">dispatcher</span><span class="p">:</span> <span class="n">CollectingDispatcher</span><span class="p">,</span>
        <span class="n">tracker</span><span class="p">:</span> <span class="n">Tracker</span><span class="p">,</span>
        <span class="n">domain</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Validate cuisine value.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuisine_db</span><span class="p">():</span>
            <span class="c1"># validation succeeded, set the value of the &quot;cuisine&quot; slot to value</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;cuisine&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dispatcher</span><span class="o">.</span><span class="n">utter_message</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;utter_wrong_cuisine&quot;</span><span class="p">)</span>
            <span class="c1"># validation failed, set this slot to None, meaning the</span>
            <span class="c1"># user will be asked for the slot again</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;cuisine&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</pre></div>
</div>
<p>As the helper validation functions return dictionaries of slot names and values
to set, you can set more slots than just the one you are validating from inside
a helper validation method. However, you are responsible for making sure that
those extra slot values are valid.</p>
<p>You can also deactivate the form directly during this validation step (in case the
slot is filled with something that you are certain can’t be handled) by returning
<code class="docutils literal notranslate"><span class="pre">self.deactivate()</span></code></p>
<p>If nothing is extracted from the user’s utterance for any of the required slots, an
<code class="docutils literal notranslate"><span class="pre">ActionExecutionRejection</span></code> error will be raised, meaning the action execution
was rejected and therefore Core will fall back onto a different policy to
predict another action.</p>
</div>
<div class="section" id="handling-unhappy-paths">
<span id="section-unhappy"></span><h2><a class="toc-backref" href="#id6">Handling unhappy paths</a><a class="headerlink" href="#handling-unhappy-paths" title="Permalink to this headline">¶</a></h2>
<p>Of course your users will not always respond with the information you ask of them.
Typically, users will ask questions, make chitchat, change their mind, or otherwise
stray from the happy path. The way this works with forms is that a form will raise
an <code class="docutils literal notranslate"><span class="pre">ActionExecutionRejection</span></code> if the user didn’t provide the requested information.
You need to handle events that might cause <code class="docutils literal notranslate"><span class="pre">ActionExecutionRejection</span></code> errors
in your stories. For example, if you expect your users to chitchat with your bot,
you could add a story like this:</p>
<div class="highlight-story notranslate"><div class="highlight"><pre><span></span><span class="gh">## chitchat</span>
<span class="vm">* request_restaurant</span>
<span class="vm">    </span>- restaurant_form
    - form{&quot;name&quot;: &quot;restaurant_form&quot;}
<span class="vm">* chitchat</span>
<span class="vm">    </span>- utter_chitchat
    - restaurant_form
    - form{&quot;name&quot;: null}
</pre></div>
</div>
<p>In some situations, users may change their mind in the middle of form action
and decide not to go forward with their initial request. In cases like this, the
assistant should stop asking for the requested slots. You can handle such situations
gracefully using a default action <code class="docutils literal notranslate"><span class="pre">action_deactivate_form</span></code> which will deactivate
the form and reset the requested slot. An example story of such conversation could
look as follows:</p>
<div class="highlight-story notranslate"><div class="highlight"><pre><span></span><span class="gh">## chitchat</span>
<span class="vm">* request_restaurant</span>
<span class="vm">    </span>- restaurant_form
    - form{&quot;name&quot;: &quot;restaurant_form&quot;}
<span class="vm">* stop</span>
<span class="vm">    </span>- utter_ask_continue
<span class="vm">* deny</span>
<span class="vm">    </span>- action_deactivate_form
    - form{&quot;name&quot;: null}
</pre></div>
</div>
<p>It is <strong>strongly</strong> recommended that you build these stories using interactive learning.
If you write these stories by hand you will likely miss important things.
Please read <a class="reference internal" href="../interactive-learning/#section-interactive-learning-forms"><span class="std std-ref">Interactive Learning with Forms</span></a>
on how to use interactive learning with forms.</p>
</div>
<div class="section" id="the-requested-slot-slot">
<h2><a class="toc-backref" href="#id7">The requested_slot slot</a><a class="headerlink" href="#the-requested-slot-slot" title="Permalink to this headline">¶</a></h2>
<p>The slot <code class="docutils literal notranslate"><span class="pre">requested_slot</span></code> is automatically added to the domain as an
unfeaturized slot. If you want to make it featurized, you need to add it
to your domain file as a categorical slot. You might want to do this if you
want to handle your unhappy paths differently depending on what slot is
currently being asked from the user. For example, say your users respond
to one of the bot’s questions with another question, like <em>why do you need to know that?</em>
The response to this <code class="docutils literal notranslate"><span class="pre">explain</span></code> intent depends on where we are in the story.
In the restaurant case, your stories would look something like this:</p>
<div class="highlight-story notranslate"><div class="highlight"><pre><span></span><span class="gh">## explain cuisine slot</span>
<span class="vm">* request_restaurant</span>
<span class="vm">    </span>- restaurant_form
    - form{&quot;name&quot;: &quot;restaurant_form&quot;}
<span class="o">    - slot</span><span class="p">{</span><span class="nt">&quot;requested_slot&quot;</span><span class="p">:</span> <span class="s2">&quot;cuisine&quot;</span><span class="p">}</span>
<span class="vm">* explain</span>
<span class="vm">    </span>- utter_explain_cuisine
    - restaurant_form
<span class="o">    - slot</span><span class="p">{</span><span class="nt">&quot;cuisine&quot;</span><span class="p">:</span> <span class="s2">&quot;greek&quot;</span><span class="p">}</span>
    ( ... all other slots the form set ... )
    - form{&quot;name&quot;: null}

<span class="gh">## explain num_people slot</span>
<span class="vm">* request_restaurant</span>
<span class="vm">    </span>- restaurant_form
    - form{&quot;name&quot;: &quot;restaurant_form&quot;}
<span class="o">    - slot</span><span class="p">{</span><span class="nt">&quot;requested_slot&quot;</span><span class="p">:</span> <span class="s2">&quot;num_people&quot;</span><span class="p">}</span>
<span class="vm">* explain</span>
<span class="vm">    </span>- utter_explain_num_people
    - restaurant_form
<span class="o">    - slot</span><span class="p">{</span><span class="nt">&quot;cuisine&quot;</span><span class="p">:</span> <span class="s2">&quot;greek&quot;</span><span class="p">}</span>
    ( ... all other slots the form set ... )
    - form{&quot;name&quot;: null}
</pre></div>
</div>
<p>Again, is is <strong>strongly</strong> recommended that you use interactive
learning to build these stories.
Please read <a class="reference internal" href="../interactive-learning/#section-interactive-learning-forms"><span class="std std-ref">Interactive Learning with Forms</span></a>
on how to use interactive learning with forms.</p>
</div>
<div class="section" id="handling-conditional-slot-logic">
<span id="conditional-logic"></span><h2><a class="toc-backref" href="#id8">Handling conditional slot logic</a><a class="headerlink" href="#handling-conditional-slot-logic" title="Permalink to this headline">¶</a></h2>
<p>Many forms require more logic than just requesting a list of fields.
For example, if someone requests <code class="docutils literal notranslate"><span class="pre">greek</span></code> as their cuisine, you may want to
ask if they are looking for somewhere with outside seating.</p>
<p>You can achieve this by writing some logic into the <code class="docutils literal notranslate"><span class="pre">required_slots()</span></code> method,
for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">required_slots</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">]:</span>
   <span class="sd">&quot;&quot;&quot;A list of required slots that the form has to fill&quot;&quot;&quot;</span>

   <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_slot</span><span class="p">(</span><span class="s1">&#39;cuisine&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;greek&#39;</span><span class="p">:</span>
     <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;cuisine&quot;</span><span class="p">,</span> <span class="s2">&quot;num_people&quot;</span><span class="p">,</span> <span class="s2">&quot;outdoor_seating&quot;</span><span class="p">,</span>
             <span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">]</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;cuisine&quot;</span><span class="p">,</span> <span class="s2">&quot;num_people&quot;</span><span class="p">,</span>
             <span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="s2">&quot;feedback&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This mechanism is quite general and you can use it to build many different
kinds of logic into your forms.</p>
</div>
<div class="section" id="debugging">
<h2><a class="toc-backref" href="#id9">Debugging</a><a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>The first thing to try is to run your bot with the <code class="docutils literal notranslate"><span class="pre">debug</span></code> flag, see <a class="reference internal" href="../../user-guide/command-line-interface/#command-line-interface"><span class="std std-ref">Command Line Interface</span></a> for details.
If you are just getting started, you probably only have a few hand-written stories.
This is a great starting point, but
you should give your bot to people to test <strong>as soon as possible</strong>. One of the guiding principles
behind Rasa Core is:</p>
<blockquote class="pull-quote">
<div><p>Learning from real conversations is more important than designing hypothetical ones</p>
</div></blockquote>
<p>So don’t try to cover every possibility in your hand-written stories before giving it to testers.
Real user behavior will always surprise you!</p>
</div>
</div>


          </div>

          <div class="footer">
            <div class="questions">
              Stuck?
              <a class="reference external" href="https://forum.rasa.com" target="_blank">Ask a Question</a>
              or
              <a class="reference external" href="https://github.com/rasahq/rasa/issues" target="_blank">Create an Issue</a>
            </div>
            <div class="social">
              <a href="https://github.com/RasaHQ" target="_blank" title="GitHub"><i class="fab fa-github"></i></a>
              <a href="https://stackoverflow.com/search?q=rasa" target="_blank" title="Stack Overflow"><i class="fab fa-stack-overflow"></i></a>
              <a href="https://www.youtube.com/channel/UCJ0V6493mLvqdiVwOKWBODQ" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
              <a href="https://twitter.com/rasa_hq" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
            </div>

            <div class="copyright small">
            &copy;2020, Rasa Technologies | <a href="https://rasa.com/imprint/" target="_blank">Imprint</a> | <a href="https://rasa.com/privacy-policy/" target="_blank">Privacy Policy</a>
            
            </div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>

    

  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag(...arguments) {
      dataLayer.push(...arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-87333416-1', {
      'anonymize_ip': true,
    });
  </script>
  <script src="https://rasa.com/assets/js/js.cookies.js"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script type="opt-in" data-name="analytics" data-type="text/javascript" data-src="https://www.googletagmanager.com/gtag/js?id=UA-87333416-1"></script>
  <script type="opt-in" data-name="analytics" data-type="text/javascript" data-src="https://rasa.com/assets/js/userId.js"></script>

  <script type="text/javascript">
    var clipboard = new ClipboardJS('.copyable');
    clipboard.on('success', function(e) {
      gtag('event', e.action, {
        'event_category': 'code',
        'event_label': e.text
      });
      const id = e.text.replace(/ /g,'-');
      document.getElementById(id).classList.add('visible');
      setTimeout(function(){
        document.getElementById(id).classList.remove('visible');},
        800
      );
    });
    clipboard.on('error', function(e) {
      console.log(e);
    });

  </script>

  <!-- ACE Editor, Train & download buttons -->
  <script>
    let updateIntervalId;

    function uuidv4() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
              (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function fetchTracker(url, chatBlockId, conversationId) {
      $.ajax({
        url: url + "/conversations/" + conversationId + "/tracker",
        method: "get",
        dataType: 'json',
        contentType: 'application/json',
        success: function(tracker, status) {
          initChatBlock(url, chatBlockId, conversationId, tracker);
        }
      });
    }

    function sendMessage(url, chatBlockId, conversationId, tracker, message) {
      $.ajax({
        url: url + "/webhooks/rest/webhook",
        method: "post",
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({
          sender: conversationId,
          message: message
        }),
        success: function(result, status) {
          fetchTracker(url, chatBlockId, conversationId);
        },
      });
    }

    function startFetchingTracker(url, chatBlockId, conversationId) {
      const interval = 2000;

      fetchTracker(url, chatBlockId, conversationId);

      updateIntervalId = setInterval(() => {
        fetchTracker(url, chatBlockId, conversationId);
      }, interval);
    }

    function initChatBlock(url, id, conversationId, tracker) {
      ChatBlock.default.init({
        onSendMessage: (message) => {
          sendMessage(url, id, conversationId, tracker, message);
        },
        username: conversationId,
        tracker: tracker,
        selector: id
      });
    }

    const chatBlockId = '#rasa-chat-block';
    const trackingId = uuidv4();

    $(document).ready(() => {
      // make editors work
      const editors = document.querySelectorAll('.ace-editor');

      const assignTrainingDataToButton = function(e, id, trainButton) {
        const trainingData = trainButton.data('training');

        trainButton.data('training', JSON.stringify({
          ...JSON.parse(trainingData || "{}") || {},
          [id]: e.getValue(),
        }));
      };

      ace.config.set('modePath', "/_static/ace/src-min-noconflict");

      Array.from(editors).forEach(function(editor) {
        const e = ace.edit(editor);
        const id = editor.dataset['id'];
        const trackingEndpoint = editor.dataset['tr-endpoint'];

        e.session.setMode("ace/mode/" + editor.dataset['language']);
        e.renderer.setShowGutter(false);
        e.renderer.setShowPrintMargin(false);
        e.renderer.setPadding(24);
        e.renderer.setScrollMargin(24);
        e.setHighlightActiveLine(false);

        if (trackingEndpoint) {
          e.on("change", function() {
            if (!editor.dataset.hasChanged) {
              editor.dataset.hasChanged = true;
              $.ajax({
                url: trackingEndpoint,
                method: "POST",
                data: {editor: id},
              });
            }
          });
        }

        const trainButton = $('.train__button');

        assignTrainingDataToButton(e, id, trainButton);
        e.on("blur", function() {
          assignTrainingDataToButton(e, id, trainButton);
        });

        editor.style.height = editor.dataset['height'] + 'px';
      });

      // initialize a chat block
      initChatBlock("", chatBlockId, trackingId, {});
    });

    // set train button callback
    $( ".train__button" ).click(function() {
      const trainButton = $('.train__button');
      const trainSpinner = $('.train__spinner');
      const downloadButton = $('.download__button');

      trainButton.prop("disabled", true);
      downloadButton.prop("disabled", true);
      trainSpinner.removeClass('train__spinner--hidden');

      if (updateIntervalId) {
        clearInterval(updateIntervalId);
        initChatBlock("", chatBlockId, trackingId, {});
      }

      $.ajax({
        url: trainButton.data('endpoint'),
        method: trainButton.data('method'),
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({ tracking_id: trackingId, ...JSON.parse(trainButton.data('training')) }),
        success: function(result, status) {
          trainSpinner.addClass('train__spinner--hidden');
          trainButton.prop("disabled", false);

          if (result['project_download_url']) {
            trainSpinner.addClass('train__spinner--hidden');
            downloadButton.prop("disabled", false);
            downloadButton.data("url", result['project_download_url']);
          }

          if (result['rasa_service_url']) {
            const conversationId = uuidv4();
            startFetchingTracker(result['rasa_service_url'], chatBlockId, conversationId);
          }
        },
        error: function(result, status) {
          trainSpinner.addClass('train__spinner--hidden');
          trainButton.prop("disabled", false);
        }
      });
    });

    // set download button callback
    $( ".download__button" ).click(function() {
      const downloadButton = $('.download__button');
      const url = downloadButton.data("url");

      if (url) {
        location.href = url;
      }
    });
  </script>

  <!-- Dismissable announcement banner -->
  <script>
    var banners = document.querySelectorAll('.announcement-banner');

    Array.from(banners).forEach(function(banner) {
      var cookie_id = banner.dataset['cookie-id'];

      if (localStorage.getItem(cookie_id) !== 'true') {
        banner.classList.add('announcement-banner--visible');
      }

      var bannerCloseButton = banner.querySelector('.announcement-banner__close');

      bannerCloseButton && bannerCloseButton.addEventListener('click', function() {
        localStorage.setItem(cookie_id, 'true');
        banner.classList.remove('announcement-banner--visible');
      });
    });
  </script>

  <!-- onsite anchor fix (otherwise anchors scroll to far) -->
  <script>
    /* Adapted from https://stackoverflow.com/a/13067009/1906073 */
    (function(document, history, location) {
      var HISTORY_SUPPORT = !!(history && history.pushState);

      var anchorScrolls = {
        ANCHOR_REGEX: /^#[^ ]+$/,
        OFFSET_HEIGHT_PX: 66,

        /**
         * Establish events, and fix initial scroll position if a hash is provided.
         */
        init: function() {
          this.scrollToCurrent();
          $(window).on('hashchange', $.proxy(this, 'scrollToCurrent'));
          $('body').on('click', 'a', $.proxy(this, 'delegateAnchors'));
        },

        /**
         * Return the offset amount to deduct from the normal scroll position.
         * Modify as appropriate to allow for dynamic calculations
         */
        getFixedOffset: function() {
          return this.OFFSET_HEIGHT_PX;
        },

        /**
         * If the provided href is an anchor which resolves to an element on the
         * page, scroll to it.
         * @param  {String} href
         * @return {Boolean} - Was the href an anchor.
         */
        scrollIfAnchor: function(href, pushToHistory) {
          var match, anchorOffset;

          if(!this.ANCHOR_REGEX.test(href)) {
            return false;
          }

          match = document.getElementById(href.slice(1));

          if(match) {
            anchorOffset = $(match).offset().top - this.getFixedOffset();
            $('html, body').animate({ scrollTop: anchorOffset});

            // Add the state to history as-per normal anchor links
            if(HISTORY_SUPPORT && pushToHistory) {
              history.pushState({}, document.title, location.pathname + href);
            }
          }

          return !!match;
        },

        /**
         * Attempt to scroll to the current location's hash.
         */
        scrollToCurrent: function(e) {
          if(this.scrollIfAnchor(window.location.hash) && e) {
            e.preventDefault();
          }
        },

        /**
         * If the click event's target was an anchor, fix the scroll position.
         */
        delegateAnchors: function(e) {
          var elem = e.target;

          if(this.scrollIfAnchor(elem.getAttribute('href'), true)) {
            e.preventDefault();
          }
        }
      };

      $(document).ready($.proxy(anchorScrolls, 'init'));
    })(window.document, window.history, window.location);

  </script>
  <script type="opt-in" data-name="analytics" data-type="text/javascript" data-src="https://rasa.com/assets/js/u-info.js"></script>
      <div class="webchat-banner webchat-banner--hidden">
        <img src="https://rasa.com/assets/img/demo/sara_avatar.png" class="webchat-banner__avatar" alt="">
        👋 I can help you get started with Rasa and answer your technical questions.
        <button class="webchat-banner__close">
          <i class="fas fa-times"></i> 
        </button>
      </div>
      <div id="webchat">
        <script src="../../_static/rasa-webchat.js"></script>
        <script>
          WebChat.default.init({
            selector: "#webchat",
            initPayload: "/greet",
            socketUrl: "https://website-demo.rasa.com/",
            socketPath: "/socket.io",
            title: "Sara",
            subtitle: "I'm still in development",
            profileAvatar: "https://rasa.com/assets/img/demo/sara_avatar.png",
            showCloseButton: true,
            fullScreenMode: false,
            hideWhenNotConnected: false,
            connectOn: "open",
            autoClearCache: true,
            linksOpenTab: false,
            openLauncherImage: "../../_static/chat-icon.svg",
            customMessageDelay: (message) => {
              return 900 + message.length;
            },
            params: {
              storage: "local"
            },
            onWidgetEvent: {
              onChatOpen: () => {
                const webchatBanner = document.querySelector('.webchat-banner');
                if (webchatBanner) {
                  localStorage.setItem('WEBCHAT_BANNER_DISMISSED', 'true');
                  webchatBanner.classList.add('webchat-banner--hidden');
                }
              }
            }
          });

          try {
            const webchatBanner = document.querySelector('.webchat-banner');

            if (webchatBanner) {
              if (localStorage.getItem('WEBCHAT_BANNER_DISMISSED') !== 'true') {
                webchatBanner.classList.remove('webchat-banner--hidden');
              }

              const webChatBannerClose = document.querySelector('.webchat-banner__close');

              webChatBannerClose && webChatBannerClose.addEventListener('click', function() {
                localStorage.setItem('WEBCHAT_BANNER_DISMISSED', 'true');
                webchatBanner.classList.add('webchat-banner--hidden');
              });
            }
          } catch (e) {}
        </script>
      </div>
  </body>
</html>