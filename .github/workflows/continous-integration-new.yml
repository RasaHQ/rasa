name: Continuous Integration New

on:
  push:
    branches:
      - main
  pull_request:
    branches:
        - main
        - 3.7.x
        # Skip any PR created by dependabot to avoid permission issues
        - '!dependabot/**'

env:
  AWS_REGION: us-east-1
  REPOSITORY: 329710836760.dkr.ecr.us-east-1.amazonaws.com/rasa-private-dev
  DEFAULT_PYTHON_VERSION: "3.10"
  
permissions:
  checks: write
  id-token: write
  pull-requests: write
  contents: read
  
jobs:
  rasa-private-dev-docker-image:
        name: rasa-private dev docker image
        runs-on: ubuntu-22.04
    
        steps:
          - name: Check out code
            uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
    
          - name: Read Poetry Version 🔢
            run: |
              echo "POETRY_VERSION=$(scripts/poetry-version.sh)" >> $GITHUB_ENV
            shell: bash
    
          - name: Configure AWS credentials
            uses: aws-actions/configure-aws-credentials@8c3f20df09ac63af7b3ae3d7c91f105f857d8497 # v3.0.1
            with:
              role-to-assume: ${{ secrets.AWS_ASSUME_ROLE_SESSION_TOKEN }}
              aws-region: ${{ env.AWS_REGION }}
    
          - name: Login to Amazon ECR
            id: login-ecr
            uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1
            with:
              mask-password: "true"
    
          # Tag in format: pr_number-shortSHA or branch_name-shortSHA
          - name: Set image tag
            run: |
              if [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
                echo "IMAGE_TAG=pr${{ github.event.number }}-$(git rev-parse --short $(cat $GITHUB_EVENT_PATH | jq -r .pull_request.head.sha))" >> $GITHUB_ENV
              else
                echo "IMAGE_TAG=${GITHUB_REF##*/}-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
              fi
    
          - name: Build base image
            run: |
              docker build . -t rasa-private:base-localdev -f docker/Dockerfile.base --platform=linux/amd64
          
          - name: Build base poetry image
            run: |
              docker build . -t rasa-private:base-poetry-localdev -f docker/Dockerfile.base-poetry --build-arg IMAGE_BASE_NAME=rasa-private --build-arg BASE_IMAGE_HASH=localdev --build-arg POETRY_VERSION=$POETRY_VERSION --platform=linux/amd64
            env:
              POETRY_VERSION: ${{ env.POETRY_VERSION }}
    
          - name: Build base builder image
            run: |
              docker build . -t rasa-private:base-builder-localdev -f docker/Dockerfile.base-builder --build-arg IMAGE_BASE_NAME=rasa-private --build-arg POETRY_VERSION=localdev --platform=linux/amd64
    
          - name: Build, tag, and push image to Amazon ECR
            env:
              IMAGE_TAG: ${{ env.IMAGE_TAG }}
            run: |
              docker build . -t $IMAGE_TAG -f Dockerfile --build-arg IMAGE_BASE_NAME=rasa-private --build-arg BASE_IMAGE_HASH=localdev --build-arg BASE_BUILDER_IMAGE_HASH=localdev --platform=linux/amd64
              docker tag $IMAGE_TAG $REPOSITORY:$IMAGE_TAG
              docker push $REPOSITORY:$IMAGE_TAG

  tracing-integration-test:
    name: Tracing Integration Tests
    needs: rasa-private-dev-docker-image
    runs-on: ubuntu-22.04-4core
    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

        # Tag in format: pr_number-shortSHA or branch_name-shortSHA
      - name: Configure image tag
        run: |
            if [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
                echo "IMAGE_TAG=pr${{ github.event.number }}-$(git rev-parse --short $(cat $GITHUB_EVENT_PATH | jq -r .pull_request.head.sha))" >> $GITHUB_ENV
            else
                echo "IMAGE_TAG=${GITHUB_REF##*/}-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
            fi

      - name: Prepare the job for integration tests
        uses: ./.github/actions/integration-test-prerequisites
        with:
            IMAGE_TAG: ${{ env.IMAGE_TAG }}
            AWS_REGION: ${{ env.AWS_REGION }}
            AWS_ARN_ROLE_TO_ASSUME: ${{ secrets.AWS_ASSUME_ROLE_SESSION_TOKEN }}
            REPOSITORY: ${{ env.REPOSITORY }}
            DEFAULT_PYTHON_VERSION: ${{ env.DEFAULT_PYTHON_VERSION }}
            POETRY_CACHE_VERSION: ${{ secrets.POETRY_CACHE_VERSION }}
            
      - name: Build action server docker container
        run: |
          docker buildx use default
          docker buildx build $ACTION_SERVER_DIR -t action_server:latest -f $ACTION_SERVER_DIR/Dockerfile --build-arg TARGET_IMAGE_REGISTRY=$REPOSITORY --build-arg IMAGE_TAG=$IMAGE_TAG --load
        env:
          ACTION_SERVER_DIR: tests_deployment/integration_tests_tracing_deployment/action_server
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          
      - name: Tracing integration testing - Run docker containers
        run: |
          make run-tracing-integration-containers
        env:
          RASA_PRO_LICENSE: ${{ secrets.RASA_PRO_LICENSE }}
          TARGET_IMAGE_REGISTRY: ${{ env.REPOSITORY }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}

      - name: Tracing integration testing -  Wait for container startup ⏳
        timeout-minutes: 15
        run: |
          bash $CHECK_CONNECTION_SCRIPT http://localhost:5006
          bash $CHECK_CONNECTION_SCRIPT http://localhost:5007
        env:
          CHECK_CONNECTION_SCRIPT: tests_deployment/integration_tests_tracing_deployment/check_connection.sh

      - name: Tracing integration testing - Test Code with Services 🩺
        env:
          PYTHONIOENCODING: "utf-8"
          RASA_TELEMETRY_WRITE_KEY: ${{ secrets.SEGMENT_WRITE_DEV_KEY }}
        run: |
          make test-tracing-integration

      - name: Tracing integration testing - Stop docker containers
        run: |
          make stop-tracing-integration-containers

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@30eadd5010312f995f0d3b3cff7fe2984f69409e # v2.16.1
        with:
          files: report*.xml
          check_name: "Tracing Integration Test Results"
          comment_mode: ${{ (github.event.workflow_run.event == 'pull_request' || github.event_name == 'pull_request') && 'always' || 'off' }}

  sequential_integration_test:
    name: Run Sequential Integration Tests
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    env:
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

    services:
      postgres:
        image: postgres:13
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          # postgres image requires password to be set
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          # FIXME: cannot use ${{ env.POSTGRES_PORT }} here
          # mapping container ports to the host
          - 5432:5432

    steps:
      - name: Check out code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Python ${{ env.DEFAULT_PYTHON_VERSION }} 🐍
        id: setup-python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: ${{ inputs.DEFAULT_PYTHON_VERSION }}

      - name: Read Poetry Version 🔢
        run: |
          echo "POETRY_VERSION=$(scripts/poetry-version.sh)" >> $GITHUB_ENV
      
      # Install & configure poetry
      -  name: Install Poetry ${{ env.POETRY_VERSION }}
         uses: snok/install-poetry@93ada01c735cc8a383ce0ce2ae205a21c415379b # v1.3.4
         with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
      
      # Load cached venv if cache exists
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install Dependencies (Linux) 📦
        run: |
          sudo apt-get -y install libpq-dev
          make install-full | tee .output
          if grep 'The lock file is not up to date' .output; then exit 1; fi
          make prepare-tests-ubuntu

      # these integration tests need to be ran in a sequential fashion,
      # due to environment constraints, so we're running them in a single process.
      - name: Test Code with Services 🩺 (sequential)
        env:
          JOBS: 1
          INTEGRATION_TEST_PYTEST_MARKERS: "sequential"
          PYTHONIOENCODING: "utf-8"
        run: |
          make test-integration
          
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@30eadd5010312f995f0d3b3cff7fe2984f69409e # v2.16.1
        with:
          files: report*.xml
          check_name: "Sequential Integration Test Results"
          comment_mode: ${{ (github.event.workflow_run.event == 'pull_request' || github.event_name == 'pull_request') && 'always' || 'off' }}