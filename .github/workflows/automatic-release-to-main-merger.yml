name: Automatic main branch merger
on:
  # whenever a pull request is merged into a release branch,
  # open a pull request to merge changes down to the main branch
  pull_request:
    branches:
      - '[0-9]+.[0-9]+.x'

    types:
      # means that the PR is closed, we still have to check if it was merged
      - closed

env:
  LABEL_TYPE: type:release-branch-port

jobs:
  update_merge_pr:
    runs-on: ubuntu-22.04

    # only run this workflow if a pull request has been merged
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout git repository ðŸ•
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Fetch git tags ðŸŽ¨
        run: git fetch --prune --unshallow --tags

      - name: Get branch name âœï¸
        id: get-branch-name
        run: |
          GITHUB_BRANCH=${GITHUB_REF/refs\/heads\//}
          echo "release_branch=${GITHUB_BRANCH}" >> $GITHUB_OUTPUT
          echo "new_branch=merge-${GITHUB_BRANCH}-main-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: Close outdated release-merge PRs ðŸ§¹
        run: |
          # fetch all open merge-PRs that have been opened from the current release branch
          gh pr list -S "is:open label:${LABEL_TYPE} head:merge-${{ steps.get-branch-name.outputs.release_branch }}-main" > prs.txt
          less prs.txt

          # extract the PR ids
          awk '{print $1}' prs.txt > pr_ids.txt

          # close all outdated PRs
          while read id; do
            gh pr close $id -d
          done <pr_ids.txt
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Create new branch ðŸ£
        if: always()
        uses: peterjgrainger/action-create-branch@64aa569aea81305305c6e92bd236d8c427debff8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: ${{ steps.get-branch-name.outputs.new_branch }}

      - name: Open pull request â˜„ï¸
        if: always()
        uses: repo-sync/pull-request@7e79a9f5dc3ad0ce53138f01df2fad14a04831c5
        with:
          # This PAT has permissions to only open PRs on this repo, should not be used for anything else
          github_token: ${{ secrets.RASABOT_GITHUB_TOKEN }}
          source_branch: ${{ steps.get-branch-name.outputs.new_branch }}
          destination_branch: main
          pr_title: Merge ${{ steps.get-branch-name.outputs.release_branch }} into main
          pr_template: .github/PULL_REQUEST_AUTOMATIC_TEMPLATE.md
          pr_label: ${LABEL_TYPE}
          pr_reviewer: ${{ github.event.pull_request.user.login }}
