name: Publish Documentation

on:
  push:
    branches:
    - 'master'
    tags:
    - '**'

# SECRETS
# - GITHUB_DOCS_KEY: generated locally, added to github repo (public key)
#                    `ssh-keygen -t rsa -b 4096 -C "Github CI Docs Key" -N "" -f key`
# - GITHUB_TOKEN: (default, from github actions)

env:
  DOCS_FOLDER: newdocs
  DOCS_BRANCH: documentation

jobs:
  docs:
    name: Build Docs
    runs-on: ubuntu-latest
    if: github.repository == 'RasaHQ/rasa'  # don't run this for master branches of forks, would fail anyways

    steps:
    - name: Checkout git repository ðŸ•
      uses: actions/checkout@v2

    - name: Set up Python 3.6 ðŸ
      uses: actions/setup-python@v1
      with:
        python-version: 3.6

    - name: Set up Node 12.x ðŸ¦™
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Read Poetry Version ðŸ”¢
      run: |
        echo "::set-env name=POETRY_VERSION::$(scripts/poetry-version.sh)"
      shell: bash

    - name: Install poetry ðŸ¦„
      uses: Gr1N/setup-poetry@v1
      with:
        poetry-version: ${{ env.POETRY_VERSION }}

    - name: Load Poetry Cached Libraries â¬‡
      uses: actions/cache@v1
      with:
        path: ~/.cache/pypoetry/virtualenvs
        key: ${{ runner.os }}-poetry-3.6-non-full-${{ hashFiles('**/poetry.lock') }}
        restore-keys: ${{ runner.os }}-poetry-3.6-non-full

    - name: Load Yarn Cached Packages â¬‡
      uses: actions/cache@v1
      with:
        path: newdocs/node_modules
        key: ${{ runner.os }}-yarn-12.x-${{ hashFiles('newdocs/yarn.lock') }}
        restore-keys: ${{ runner.os }}-yarn-12.x

    - name: Install Dependencies ðŸ“¦
      run: make install install-docs

    - name: Build Docs variables ðŸ§¶
      run: cd $DOCS_FOLDER && poetry run yarn variables

    - name: Build & Publish Docs ðŸƒâ€â™€ï¸
      env:
        GITHUB_DOCS_KEY: ${{ secrets.GITHUB_DOCS_KEY }}
        TMP_DOCS_FOLDER: ~/tmp-documentation
      run: |
        eval "$(ssh-agent -s)"; touch docs_key; chmod 0600 docs_key
        echo "$GITHUB_DOCS_KEY" > "docs_key"
        ssh-add docs_key

        git config --global user.email "builds@github-ci.com"
        git config --global user.name "GitHub CI"
        git remote set-url --push origin "git@github.com:${{github.repository}}"

        ./scripts/push_docs_to_branch.sh
